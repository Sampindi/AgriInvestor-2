{% extends "base.html" %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
<script>
    // Chart data for the various dashboard charts
    {% if current_user.user_type == 'admin' %}
        // Admin dashboard data
        const userGrowthLabels = [
            {% for month in months %}
                "{{ month }}",
            {% endfor %}
        ];
        
        const farmerGrowthData = [
            {% for count in farmer_growth_data %}
                {{ count }},
            {% endfor %}
        ];
        
        const investorGrowthData = [
            {% for count in investor_growth_data %}
                {{ count }},
            {% endfor %}
        ];
        
        const fundingCategoryLabels = [
            {% for label in funding_category_labels %}
                "{{ label }}",
            {% endfor %}
        ];
        
        const fundingCategoryData = [
            {% for data in funding_category_data %}
                {{ data }},
            {% endfor %}
        ];
        
        const projectStatusData = [
            {{ projects|selectattr('funding_percentage', 'lt', 100)|selectattr('days_remaining', 'gt', 0)|list|length or 0 }},
            {{ projects|selectattr('funding_percentage', 'eq', 100)|list|length or 0 }},
            {{ projects|selectattr('days_remaining', 'le', 0)|list|length or 0 }}
        ];
    {% elif current_user.user_type == 'farmer' %}
        // Farmer dashboard data
        const projectTitleLabels = [
            {% for project in projects %}
                "{{ project.title }}",
            {% endfor %}
        ];
        
        const currentFundingData = [
            {% for project in projects %}
                {{ project.total_invested }},
            {% endfor %}
        ];
        
        const fundingGoalData = [
            {% for project in projects %}
                {{ project.funding_goal }},
            {% endfor %}
        ];
        
        const investorInterestData = [90, 80, 70, 60, 85, 55];
    {% elif current_user.user_type == 'investor' %}
        // Investor dashboard data
        const investmentProjectLabels = [
            {% for investment in investments %}
                "{{ investment.project.title }}",
            {% endfor %}
        ];
        
        const investmentAmountData = [
            {% for investment in investments %}
                {{ investment.amount }},
            {% endfor %}
        ];
        
        const investmentGoalData = [
            {% for investment in investments %}
                {{ investment.project.funding_goal }},
            {% endfor %}
        ];
        
        const investmentCategoryLabels = ['Equipment', 'Expansion', 'Technology', 'Infrastructure', 'Organic'];
        const investmentCategoryData = [15, 30, 25, 10, 20];
    {% endif %}
</script>
{% endblock %}

{% block content %}
<section class="dashboard">
    <div class="container">
        <div class="dashboard-header mb-4">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h1 class="animated-gradient">
                        {% if current_user.user_type == 'farmer' %}
                            Farmer Dashboard
                        {% elif current_user.user_type == 'investor' %}
                            Investor Dashboard
                        {% else %}
                            Admin Dashboard
                        {% endif %}
                    </h1>
                    <p class="text-secondary">
                        {% if current_user.user_type == 'farmer' %}
                            Manage your agricultural projects and connect with investors
                        {% elif current_user.user_type == 'investor' %}
                            Discover and track agricultural investment opportunities
                        {% else %}
                            Manage platform users, monitor activities, and analyze platform performance
                        {% endif %}
                    </p>
                    
                    <div class="dashboard-welcome mt-3">
                        <p class="welcome-message">Welcome back, <span class="username-highlight">{{ current_user.username }}</span>!</p>
                        <p class="last-login">Last login: {{ format_date(current_user.last_login) if current_user.last_login else 'First login' }}</p>
                    </div>
                </div>
                <div class="col-md-6 text-md-end">
                    {% if current_user.user_type == 'farmer' %}
                        <a href="{{ url_for('new_project') }}" class="btn-modern"><i class="fas fa-plus"></i> Create New Project</a>
                    {% elif current_user.user_type == 'investor' %}
                        <a href="{{ url_for('opportunities') }}" class="btn-modern"><i class="fas fa-search"></i> Find Opportunities</a>
                    {% else %}
                        <a href="#user-management" class="btn-modern"><i class="fas fa-users"></i> Manage Users</a>
                    {% endif %}
                </div>
            </div>
        </div>

        {% if current_user.user_type == 'admin' %}
        <!-- Admin Dashboard -->
        <div id="user-management" class="admin-dashboard mb-5">
            <div class="row">
                <!-- Platform Statistics -->
                <div class="col-lg-12 mb-4">
                    <div class="dashboard-card glow-on-hover">
                        <div class="dashboard-card-title">
                            <h3><i class="fas fa-chart-pie me-2"></i> Platform Analytics</h3>
                            <span class="badge-modern badge-info">Real-time</span>
                        </div>
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="stats-card">
                                    <div class="stats-icon">
                                        <i class="fas fa-users"></i>
                                    </div>
                                    <div class="stats-number">{{ users|length }}</div>
                                    <div class="stats-text">Total Users</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stats-card">
                                    <div class="stats-icon">
                                        <i class="fas fa-tractor"></i>
                                    </div>
                                    <div class="stats-number">{{ farmers|length }}</div>
                                    <div class="stats-text">Farmers</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stats-card">
                                    <div class="stats-icon">
                                        <i class="fas fa-chart-line"></i>
                                    </div>
                                    <div class="stats-number">{{ investors|length }}</div>
                                    <div class="stats-text">Investors</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stats-card">
                                    <div class="stats-icon">
                                        <i class="fas fa-project-diagram"></i>
                                    </div>
                                    <div class="stats-number">{{ projects|length }}</div>
                                    <div class="stats-text">Projects</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Financial Overview -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="summary-card">
                                    <h4 class="summary-title"><i class="fas fa-money-bill-wave me-2"></i> Financial Overview</h4>
                                    <div class="summary-content">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <h5>Total Funding Requested</h5>
                                                <p class="h3 text-primary">{{ format_currency(total_funding_requested) }}</p>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <h5>Total Funding Invested</h5>
                                                <p class="h3 text-success">{{ format_currency(total_funding_received) }}</p>
                                            </div>
                                        </div>
                                        <div class="progress mt-2" style="height: 10px;">
                                            <div class="progress-bar bg-success" role="progressbar" 
                                                 style="width: {{ (total_funding_received / total_funding_requested * 100) if total_funding_requested > 0 else 0 }}%"
                                                 aria-valuenow="{{ (total_funding_received / total_funding_requested * 100) if total_funding_requested > 0 else 0 }}" 
                                                 aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                                        <p class="text-center mt-2">
                                            <small>{{ "%.1f"|format((total_funding_received / total_funding_requested * 100) if total_funding_requested > 0 else 0) }}% of funding goals met</small>
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="summary-card">
                                    <h4 class="summary-title"><i class="fas fa-chart-bar me-2"></i> Project Status</h4>
                                    <div class="summary-content">
                                        <div class="row text-center">
                                            <div class="col-md-4 mb-3">
                                                <h5>Active</h5>
                                                <p class="h3 text-info">
                                                    {{ projects|selectattr('is_funded', 'equalto', false)|selectattr('is_expired', 'equalto', false)|list|length }}
                                                </p>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <h5>Funded</h5>
                                                <p class="h3 text-success">
                                                    {{ projects|selectattr('is_funded', 'equalto', true)|list|length }}
                                                </p>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <h5>Expired</h5>
                                                <p class="h3 text-danger">
                                                    {{ projects|selectattr('is_expired', 'equalto', true)|list|length }}
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Analytics Charts -->
                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <div class="chart-container">
                                    <canvas id="userGrowthChart"></canvas>
                                </div>
                            </div>
                            <div class="col-md-6 mb-4">
                                <div class="chart-container">
                                    <canvas id="projectStatusChart"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-12 mb-4">
                                <div class="chart-container">
                                    <canvas id="fundingDistributionChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- User Management -->
            <div class="row">
                <div class="col-lg-12 mb-4">
                    <div class="dashboard-card glow-on-hover">
                        <div class="dashboard-card-title">
                            <h3><i class="fas fa-user-shield me-2"></i> User Management</h3>
                            <div>
                                <a href="#" class="dashboard-action me-2">
                                    <i class="fas fa-user-plus me-1"></i> Add User
                                </a>
                                <a href="#" class="dashboard-action">
                                    <i class="fas fa-download me-1"></i> Export
                                </a>
                            </div>
                        </div>
                        
                        <!-- Search and Filter -->
                        <div class="row mb-4">
                            <div class="col-md-8">
                                <div class="input-group">
                                    <span class="input-group-text bg-transparent border-end-0">
                                        <i class="fas fa-search"></i>
                                    </span>
                                    <input type="text" class="form-control border-start-0" placeholder="Search users...">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <select class="form-select">
                                    <option value="">All User Types</option>
                                    <option value="farmer">Farmers</option>
                                    <option value="investor">Investors</option>
                                    <option value="admin">Admins</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="data-table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Username</th>
                                        <th>Email</th>
                                        <th>Type</th>
                                        <th>Joined</th>
                                        <th>Last Login</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for user in users %}
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="user-avatar me-2">
                                                    <div style="width: 40px; height: 40px; background-color: var(--primary-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--text-primary); font-size: 16px;">
                                                        {{ user.username[0].upper() }}
                                                    </div>
                                                </div>
                                                <div>
                                                    <div>{{ user.username }}</div>
                                                    <small class="text-secondary">ID: {{ user.id }}</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td>{{ user.email }}</td>
                                        <td>
                                            <span class="badge-modern 
                                                {% if user.user_type == 'farmer' %}
                                                    badge-success
                                                {% elif user.user_type == 'investor' %}
                                                    badge-info
                                                {% else %}
                                                    badge-danger
                                                {% endif %}
                                            ">
                                                {{ user.user_type|capitalize }}
                                            </span>
                                        </td>
                                        <td>{{ format_date(user.created_at) }}</td>
                                        <td>{{ format_date(user.last_login) if user.last_login else 'Never' }}</td>
                                        <td>
                                            <span class="badge-modern badge-success">Active</span>
                                        </td>
                                        <td>
                                            <div class="d-flex gap-2">
                                                <a href="#" class="btn-modern btn-sm">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                <a href="#" class="btn-modern btn-sm">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                                <a href="#" class="btn-modern btn-sm">
                                                    <i class="fas fa-ban"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Pagination -->
                        <div class="d-flex justify-content-between align-items-center mt-4">
                            <div>
                                <span class="text-secondary">Showing {{ users|length }} of {{ users|length }} users</span>
                            </div>
                            <nav>
                                <ul class="pagination">
                                    <li class="page-item disabled">
                                        <a class="page-link" href="#"><i class="fas fa-chevron-left"></i></a>
                                    </li>
                                    <li class="page-item active">
                                        <a class="page-link" href="#">1</a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="#"><i class="fas fa-chevron-right"></i></a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Project Management -->
            <div class="row">
                <div class="col-lg-12 mb-4">
                    <div class="dashboard-card glow-on-hover">
                        <div class="dashboard-card-title">
                            <h3><i class="fas fa-project-diagram me-2"></i> Project Management</h3>
                            <div>
                                <a href="#" class="dashboard-action me-2">
                                    <i class="fas fa-plus me-1"></i> Add Project
                                </a>
                                <a href="#" class="dashboard-action">
                                    <i class="fas fa-download me-1"></i> Export
                                </a>
                            </div>
                        </div>
                        
                        <!-- Project Filtering -->
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="input-group">
                                    <span class="input-group-text bg-transparent border-end-0">
                                        <i class="fas fa-search"></i>
                                    </span>
                                    <input type="text" class="form-control border-start-0" placeholder="Search projects...">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <select class="form-select">
                                    <option value="">All Categories</option>
                                    <option value="equipment">Farm Equipment</option>
                                    <option value="expansion">Farm Expansion</option>
                                    <option value="technology">New Technology</option>
                                    <option value="infrastructure">Infrastructure</option>
                                    <option value="organic">Organic Transition</option>
                                    <option value="startup">Farm Startup</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <select class="form-select">
                                    <option value="">All Statuses</option>
                                    <option value="active">Active</option>
                                    <option value="funded">Funded</option>
                                    <option value="expired">Expired</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="data-table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Project</th>
                                        <th>Farmer</th>
                                        <th>Category</th>
                                        <th>Funding Goal</th>
                                        <th>Progress</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for project in projects %}
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="project-icon me-2">
                                                    <div style="width: 40px; height: 40px; background-color: var(--secondary-color); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--text-primary); font-size: 16px;">
                                                        <i class="fas fa-{{ project.category_icon or 'seedling' }}"></i>
                                                    </div>
                                                </div>
                                                <div>
                                                    <div>{{ project.title }}</div>
                                                    <small class="text-secondary">Created: {{ format_date(project.created_at) }}</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="user-avatar me-2">
                                                    <div style="width: 30px; height: 30px; background-color: var(--primary-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--text-primary); font-size: 12px;">
                                                        {{ project.farmer.username[0].upper() }}
                                                    </div>
                                                </div>
                                                <div>{{ project.farmer.username }}</div>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge-modern badge-info">
                                                {{ project.category|capitalize if project.category else 'Other' }}
                                            </span>
                                        </td>
                                        <td>{{ format_currency(project.funding_goal) }}</td>
                                        <td>
                                            <div class="d-flex align-items-center gap-2">
                                                <div class="progress flex-grow-1" style="height: 8px;">
                                                    <div class="progress-bar bg-success" role="progressbar" 
                                                         style="width: {{ project.funding_percentage }}%"
                                                         aria-valuenow="{{ project.funding_percentage }}" 
                                                         aria-valuemin="0" aria-valuemax="100"></div>
                                                </div>
                                                <span>{{ "%.1f"|format(project.funding_percentage) }}%</span>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge-modern 
                                                {% if project.is_funded %}
                                                    badge-success
                                                {% elif project.is_expired %}
                                                    badge-danger
                                                {% else %}
                                                    badge-info
                                                {% endif %}
                                            ">
                                                {% if project.is_funded %}
                                                    Funded
                                                {% elif project.is_expired %}
                                                    Expired
                                                {% else %}
                                                    Active
                                                {% endif %}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="d-flex gap-2">
                                                <a href="{{ url_for('project_detail', project_id=project.id) }}" class="btn-modern btn-sm">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                <a href="#" class="btn-modern btn-sm">
                                                    <i class="fas fa-star"></i>
                                                </a>
                                                <a href="#" class="btn-modern btn-sm">
                                                    <i class="fas fa-trash-alt"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Pagination -->
                        <div class="d-flex justify-content-between align-items-center mt-4">
                            <div>
                                <span class="text-secondary">Showing {{ projects|length }} of {{ projects|length }} projects</span>
                            </div>
                            <nav>
                                <ul class="pagination">
                                    <li class="page-item disabled">
                                        <a class="page-link" href="#"><i class="fas fa-chevron-left"></i></a>
                                    </li>
                                    <li class="page-item active">
                                        <a class="page-link" href="#">1</a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="#"><i class="fas fa-chevron-right"></i></a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Recent Activity -->
            <div class="row">
                <div class="col-lg-6 mb-4">
                    <div class="dashboard-card glow-on-hover">
                        <div class="dashboard-card-title">
                            <h3><i class="fas fa-bell me-2"></i> Recent Activity</h3>
                        </div>
                        <div class="activity-feed">
                            <div class="activity-item">
                                <div class="activity-icon">
                                    <i class="fas fa-user-plus"></i>
                                </div>
                                <div class="activity-content">
                                    <div class="activity-title">New User Registration</div>
                                    <div class="activity-description">
                                        User <strong>johndoe</strong> has registered as a farmer.
                                    </div>
                                    <div class="activity-time">2 hours ago</div>
                                </div>
                            </div>
                            <div class="activity-item">
                                <div class="activity-icon">
                                    <i class="fas fa-project-diagram"></i>
                                </div>
                                <div class="activity-content">
                                    <div class="activity-title">New Project Created</div>
                                    <div class="activity-description">
                                        <strong>Organic Wheat Farm Expansion</strong> created by <strong>farmerbob</strong>.
                                    </div>
                                    <div class="activity-time">5 hours ago</div>
                                </div>
                            </div>
                            <div class="activity-item">
                                <div class="activity-icon">
                                    <i class="fas fa-dollar-sign"></i>
                                </div>
                                <div class="activity-content">
                                    <div class="activity-title">Investment Made</div>
                                    <div class="activity-description">
                                        <strong>investor123</strong> invested $5,000 in <strong>Sustainable Irrigation Project</strong>.
                                    </div>
                                    <div class="activity-time">Yesterday</div>
                                </div>
                            </div>
                            <div class="activity-item">
                                <div class="activity-icon">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <div class="activity-content">
                                    <div class="activity-title">Project Fully Funded</div>
                                    <div class="activity-description">
                                        <strong>Greenhouse Expansion</strong> reached 100% of funding goal.
                                    </div>
                                    <div class="activity-time">3 days ago</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Users -->
                <div class="col-lg-6 mb-4">
                    <div class="dashboard-card glow-on-hover">
                        <div class="dashboard-card-title">
                            <h3><i class="fas fa-users me-2"></i> Recent Users</h3>
                        </div>
                        <div class="recent-users">
                            {% for user in recent_users %}
                            <div class="d-flex align-items-center mb-3 p-2 rounded hover-bg">
                                <div class="user-avatar me-3">
                                    <div style="width: 50px; height: 50px; background-color: var(--primary-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--text-primary); font-size: 20px;">
                                        {{ user.username[0].upper() }}
                                    </div>
                                </div>
                                <div class="flex-grow-1">
                                    <div class="d-flex justify-content-between">
                                        <h5 class="mb-0">{{ user.username }}</h5>
                                        <span class="badge-modern 
                                            {% if user.user_type == 'farmer' %}
                                                badge-success
                                            {% elif user.user_type == 'investor' %}
                                                badge-info
                                            {% else %}
                                                badge-danger
                                            {% endif %}
                                        ">
                                            {{ user.user_type|capitalize }}
                                        </span>
                                    </div>
                                    <p class="text-secondary mb-0">{{ user.email }}</p>
                                    <small>Joined: {{ format_date(user.created_at) }}</small>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <!-- Profile Overview -->
        <div class="row mb-5">
            <div class="col-lg-4 mb-4">
                <div class="dashboard-card glow-on-hover">
                    <div class="dashboard-card-title">
                        <h3>
                            <i class="fas {% if current_user.user_type == 'farmer' %}fa-tractor{% else %}fa-chart-line{% endif %} me-2"></i>
                            Profile Overview
                        </h3>
                        <a href="{{ url_for('profile') }}" class="dashboard-action"><i class="fas fa-edit me-1"></i> Edit</a>
                    </div>
                    {% if current_user.user_type == 'farmer' %}
                        <div class="profile-card mb-4">
                            <div class="text-center mb-4">
                                <div class="user-avatar mx-auto mb-3">
                                    <div style="width: 100px; height: 100px; background-color: var(--primary-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--text-primary); font-size: 36px; margin: 0 auto;">
                                        {{ current_user.username[0].upper() }}
                                    </div>
                                </div>
                                <h3 class="mb-1">{{ current_user.username }}</h3>
                                <p class="text-secondary">{{ current_user.email }}</p>
                                
                                {% if current_user.farmer_profile %}
                                    <div class="profile-rating mb-2">
                                        {% set avg_rating = current_user.get_avg_rating() %}
                                        <div class="d-flex align-items-center justify-content-center">
                                            <div class="rating-stars me-2">
                                                {% for i in range(1, 6) %}
                                                    <i class="fas fa-star {% if i <= avg_rating %}text-warning{% else %}text-secondary{% endif %}"></i>
                                                {% endfor %}
                                            </div>
                                            <span>{{ "%.1f"|format(avg_rating) }}</span>
                                        </div>
                                        <small>({{ current_user.ratings_received.count() }} reviews)</small>
                                    </div>
                                    
                                    <div class="credibility-score mb-3">
                                        <h6>Credibility Score</h6>
                                        <div class="progress mb-2" style="height: 8px;">
                                            <div class="progress-bar bg-success" role="progressbar" 
                                                style="width: {{ credibility_score }}%"
                                                aria-valuenow="{{ credibility_score }}" 
                                                aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                                        <small>{{ credibility_score }}% - {{ 'Excellent' if credibility_score >= 90 else 'Good' if credibility_score >= 70 else 'Fair' if credibility_score >= 50 else 'Needs Improvement' }}</small>
                                    </div>
                                {% endif %}
                            </div>
                            
                            {% if current_user.farmer_profile %}
                                <div class="profile-info-item">
                                    <div class="profile-info-label">Farm Name:</div>
                                    <div class="profile-info-value">{{ current_user.farmer_profile.farm_name }}</div>
                                </div>
                                <div class="profile-info-item">
                                    <div class="profile-info-label">Location:</div>
                                    <div class="profile-info-value">{{ current_user.farmer_profile.location }}</div>
                                </div>
                                <div class="profile-info-item">
                                    <div class="profile-info-label">Farm Size:</div>
                                    <div class="profile-info-value">{{ current_user.farmer_profile.size }} acres</div>
                                </div>
                                <div class="profile-info-item">
                                    <div class="profile-info-label">Crops:</div>
                                    <div class="profile-info-value">{{ current_user.farmer_profile.crops or 'Not specified' }}</div>
                                </div>
                                <div class="profile-info-item">
                                    <div class="profile-info-label">Technologies:</div>
                                    <div class="profile-info-value">{{ current_user.farmer_profile.technologies or 'Not specified' }}</div>
                                </div>
                            {% else %}
                                <div class="text-center py-4">
                                    <p class="mb-3"><i class="fas fa-info-circle me-2"></i>You haven't created your farmer profile yet.</p>
                                    <p>Complete your profile to connect with potential investors and showcase your agricultural projects.</p>
                                    <a href="{{ url_for('profile') }}" class="btn btn-primary mt-3">Create Profile</a>
                                </div>
                            {% endif %}
                        </div>
                    {% elif current_user.user_type == 'investor' %}
                        <div class="profile-card mb-4">
                            <div class="text-center mb-4">
                                <div class="user-avatar mx-auto mb-3">
                                    <div style="width: 100px; height: 100px; background-color: var(--secondary-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--text-primary); font-size: 36px; margin: 0 auto;">
                                        {{ current_user.username[0].upper() }}
                                    </div>
                                </div>
                                <h3 class="mb-1">{{ current_user.username }}</h3>
                                <p class="text-secondary">{{ current_user.email }}</p>
                                
                                {% if current_user.investor_profile and current_user.investor_profile.company_name %}
                                    <div class="company-badge mb-3">
                                        <span class="badge-modern badge-info">{{ current_user.investor_profile.company_name }}</span>
                                    </div>
                                {% endif %}
                            </div>
                            
                            {% if current_user.investor_profile %}
                                <div class="profile-info-item">
                                    <div class="profile-info-label">Company:</div>
                                    <div class="profile-info-value">{{ current_user.investor_profile.company_name or 'Not specified' }}</div>
                                </div>
                                <div class="profile-info-item">
                                    <div class="profile-info-label">Investment Range:</div>
                                    <div class="profile-info-value">
                                        {% if current_user.investor_profile.min_investment and current_user.investor_profile.max_investment %}
                                            {{ format_currency(current_user.investor_profile.min_investment) }} - {{ format_currency(current_user.investor_profile.max_investment) }}
                                        {% else %}
                                            Not specified
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="profile-info-item">
                                    <div class="profile-info-label">Focus Areas:</div>
                                    <div class="profile-info-value">
                                        {% if current_user.investor_profile.investment_focus %}
                                            <div class="d-flex flex-wrap gap-1">
                                                {% for focus in current_user.investor_profile.investment_focus.split(',') %}
                                                    <span class="badge-modern badge-info">{{ focus.strip() }}</span>
                                                {% endfor %}
                                            </div>
                                        {% else %}
                                            Not specified
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="profile-info-item">
                                    <div class="profile-info-label">Preferred Locations:</div>
                                    <div class="profile-info-value">
                                        {{ current_user.investor_profile.preferred_locations or 'Not specified' }}
                                    </div>
                                </div>
                            {% else %}
                                <div class="text-center py-4">
                                    <p class="mb-3"><i class="fas fa-info-circle me-2"></i>You haven't created your investor profile yet.</p>
                                    <p>Complete your profile to discover agricultural projects and connect with farmers looking for funding.</p>
                                    <a href="{{ url_for('profile') }}" class="btn btn-primary mt-3">Create Profile</a>
                                </div>
                            {% endif %}
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            <p>Your profile is not complete. Please <a href="{{ url_for('profile') }}" class="hover-underline">complete your profile</a> to get the most out of the platform.</p>
                            <div class="mt-3 text-center">
                                <a href="{{ url_for('profile') }}" class="btn-modern"><i class="fas fa-user-edit me-2"></i> Complete Your Profile</a>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Stats and Analytics -->
            <div class="col-lg-8">
                <!-- Stats Cards -->
                <div class="row mb-4">
                    {% if current_user.user_type == 'farmer' %}
                        <div class="col-md-4">
                            <div class="stats-card">
                                <div class="stats-icon">
                                    <i class="fas fa-project-diagram"></i>
                                </div>
                                <div class="stats-number">{{ projects|length }}</div>
                                <div class="stats-text">Active Projects</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stats-card">
                                <div class="stats-icon">
                                    <i class="fas fa-dollar-sign"></i>
                                </div>
                                <div class="stats-number">
                                    {% set total_funding = 0 %}
                                    {% for project in projects %}
                                        {% set total_funding = total_funding + project.funding_goal %}
                                    {% endfor %}
                                    {{ format_currency(total_funding) }}
                                </div>
                                <div class="stats-text">Total Funding Goal</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stats-card">
                                <div class="stats-icon">
                                    <i class="fas fa-handshake"></i>
                                </div>
                                <div class="stats-number">{{ connected_investors|length }}</div>
                                <div class="stats-text">Connected Investors</div>
                            </div>
                        </div>
                        
                        <!-- Farmer Dashboard Charts -->
                        <div class="col-md-12 mt-4">
                            <div class="dashboard-card glow-on-hover">
                                <div class="dashboard-card-title">
                                    <h3><i class="fas fa-chart-bar me-2"></i> Funding Analytics</h3>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="chart-container">
                                            <canvas id="fundingProgressChart"></canvas>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="summary-card h-100 d-flex flex-column justify-content-center">
                                            <h4 class="summary-title"><i class="fas fa-seedling me-2"></i> Funding Status</h4>
                                            <div class="summary-content">
                                                {% set total_received = 0 %}
                                                {% for project in projects %}
                                                    {% set total_received = total_received + project.total_invested %}
                                                {% endfor %}
                                                
                                                <div class="mb-3">
                                                    <h5>Funding Goals</h5>
                                                    <p class="h3 text-primary">{{ format_currency(total_funding) }}</p>
                                                </div>
                                                
                                                <div class="mb-3">
                                                    <h5>Funding Received</h5>
                                                    <p class="h3 text-success">{{ format_currency(total_received) }}</p>
                                                </div>
                                                
                                                <div class="progress mt-2" style="height: 10px;">
                                                    <div class="progress-bar bg-success" role="progressbar" 
                                                         style="width: {{ (total_received / total_funding * 100) if total_funding > 0 else 0 }}%"
                                                         aria-valuenow="{{ (total_received / total_funding * 100) if total_funding > 0 else 0 }}" 
                                                         aria-valuemin="0" aria-valuemax="100"></div>
                                                </div>
                                                <p class="text-center mt-2">
                                                    <small>{{ "%.1f"|format((total_received / total_funding * 100) if total_funding > 0 else 0) }}% of goals funded</small>
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mt-4">
                                    <div class="col-md-6">
                                        <div class="chart-container">
                                            <canvas id="investorInterestChart"></canvas>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="dashboard-card-title">
                                            <h4><i class="fas fa-users me-2"></i> Investor Recommendations</h4>
                                        </div>
                                        
                                        <div class="recommended-investors">
                                            {% for investor in recommended_investors[:3] %}
                                                <div class="d-flex align-items-center mb-3 p-2 rounded hover-bg">
                                                    <div class="user-avatar me-3">
                                                        <div style="width: 40px; height: 40px; background-color: var(--secondary-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--text-primary); font-size: 16px;">
                                                            {{ investor.username[0].upper() }}
                                                        </div>
                                                    </div>
                                                    <div class="flex-grow-1">
                                                        <h5 class="mb-0">{{ investor.username }}</h5>
                                                        <p class="text-secondary mb-0">
                                                            {% if investor.investor_profile and investor.investor_profile.investment_focus %}
                                                                Focus: {{ investor.investor_profile.investment_focus.split(',')[0] }}...
                                                            {% else %}
                                                                Investor
                                                            {% endif %}
                                                        </p>
                                                    </div>
                                                    <a href="#" class="btn-modern btn-sm">Connect</a>
                                                </div>
                                            {% else %}
                                                <div class="text-center text-secondary py-4">
                                                    <p><i class="fas fa-info-circle me-2"></i> No investor recommendations available yet.</p>
                                                    <p>Complete your profile and create projects to get matched with investors.</p>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="col-md-4">
                            <div class="stats-card">
                                <div class="stats-icon">
                                    <i class="fas fa-search-dollar"></i>
                                </div>
                                <div class="stats-number">{{ recommended_projects|length }}</div>
                                <div class="stats-text">Matching Projects</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stats-card">
                                <div class="stats-icon">
                                    <i class="fas fa-hand-holding-usd"></i>
                                </div>
                                <div class="stats-number">{{ investments|length }}</div>
                                <div class="stats-text">Active Investments</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stats-card">
                                <div class="stats-icon">
                                    <i class="fas fa-dollar-sign"></i>
                                </div>
                                <div class="stats-number">
                                    {% set total_invested = 0 %}
                                    {% for investment in investments %}
                                        {% set total_invested = total_invested + investment.amount %}
                                    {% endfor %}
                                    {{ format_currency(total_invested) }}
                                </div>
                                <div class="stats-text">Total Invested</div>
                            </div>
                        </div>
                        
                        <!-- Investor Dashboard Charts -->
                        <div class="col-md-12 mt-4">
                            <div class="dashboard-card glow-on-hover">
                                <div class="dashboard-card-title">
                                    <h3><i class="fas fa-chart-bar me-2"></i> Investment Analytics</h3>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="chart-container">
                                            <canvas id="investmentPerformanceChart"></canvas>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="chart-container">
                                            <canvas id="investmentCategoryChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mt-4">
                                    <div class="col-md-12">
                                        <div class="dashboard-card-title">
                                            <h4><i class="fas fa-lightbulb me-2"></i> Recommended Projects</h4>
                                        </div>
                                        
                                        <div class="row">
                                            {% for project in recommended_projects[:3] %}
                                                <div class="col-md-4 mb-3">
                                                    <div class="project-recommendation-card p-3 rounded">
                                                        <div class="d-flex align-items-center mb-2">
                                                            <div class="project-icon me-2">
                                                                <div style="width: 40px; height: 40px; background-color: var(--primary-color); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--text-primary); font-size: 16px;">
                                                                    <i class="fas fa-{{ project.category_icon or 'seedling' }}"></i>
                                                                </div>
                                                            </div>
                                                            <div>
                                                                <h5 class="mb-0">{{ project.title }}</h5>
                                                                <small>by {{ project.farmer.username }}</small>
                                                            </div>
                                                        </div>
                                                        
                                                        <div class="project-details-mini">
                                                            <div class="d-flex justify-content-between">
                                                                <span>Goal:</span>
                                                                <span>{{ format_currency(project.funding_goal) }}</span>
                                                            </div>
                                                            <div class="d-flex justify-content-between">
                                                                <span>Progress:</span>
                                                                <span>{{ "%.1f"|format(project.funding_percentage) }}%</span>
                                                            </div>
                                                            <div class="progress mt-2 mb-2" style="height: 5px;">
                                                                <div class="progress-bar bg-success" role="progressbar" 
                                                                     style="width: {{ project.funding_percentage }}%"
                                                                     aria-valuenow="{{ project.funding_percentage }}" 
                                                                     aria-valuemin="0" aria-valuemax="100"></div>
                                                            </div>
                                                        </div>
                                                        
                                                        <a href="{{ url_for('project_detail', project_id=project.id) }}" class="btn-modern btn-sm w-100">View Project</a>
                                                    </div>
                                                </div>
                                            {% else %}
                                                <div class="col-12 text-center text-secondary py-4">
                                                    <p><i class="fas fa-info-circle me-2"></i> No recommended projects available yet.</p>
                                                    <p>Complete your investor profile to get matched with suitable farming projects.</p>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        {% if current_user.user_type == 'farmer' %}
            <!-- Farmer's Projects -->
            <div class="dashboard-card mb-5">
                <div class="dashboard-card-title mb-4">
                    <h3>My Projects</h3>
                    <a href="{{ url_for('new_project') }}" class="btn btn-sm btn-primary">New Project</a>
                </div>
                
                {% if projects %}
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Project</th>
                                    <th>Location</th>
                                    <th>Category</th>
                                    <th>Funding Goal</th>
                                    <th>Created</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for project in projects %}
                                    <tr>
                                        <td>{{ project.title }}</td>
                                        <td>{{ project.location }}</td>
                                        <td>{{ project.category }}</td>
                                        <td>{{ format_currency(project.funding_goal) }}</td>
                                        <td>{{ format_date(project.created_at) }}</td>
                                        <td><span class="project-status status-active">Active</span></td>
                                        <td>
                                            <a href="{{ url_for('project_detail', project_id=project.id) }}" class="btn btn-sm btn-outline">View</a>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <div class="feature-icon mb-3">
                            <i class="fas fa-seedling"></i>
                        </div>
                        <h4>No Projects Yet</h4>
                        <p class="text-secondary">Start showcasing your agricultural projects to potential investors</p>
                        <a href="{{ url_for('new_project') }}" class="btn btn-primary mt-3">Create Your First Project</a>
                    </div>
                {% endif %}
            </div>
        {% else %}
            <!-- Investor's Matching Projects -->
            <div class="dashboard-card mb-5">
                <div class="dashboard-card-title mb-4">
                    <h3>Matching Projects</h3>
                    <a href="{{ url_for('opportunities') }}" class="btn btn-sm btn-primary">View All</a>
                </div>
                
                {% if projects %}
                    <div class="row">
                        {% for project in projects[:3] %}
                            <div class="col-lg-4 mb-4">
                                <div class="card h-100">
                                    <img src="https://pixabay.com/get/g839a8657ad2757fe0563f9eba0af3e962e7560020a682d9fe2e2f9b20b7f10e26479ad7452edef732a7e3e6d2d92276be6259949e687c10742850d74878b6a00_1280.jpg" alt="{{ project.title }}" class="card-img-top">
                                    <div class="card-body">
                                        <h4>{{ project.title }}</h4>
                                        <p class="text-secondary mb-2"><i class="fas fa-map-marker-alt"></i> {{ project.location }}</p>
                                        <p>{{ project.description|truncate(100) }}</p>
                                        <div class="progress mb-2">
                                            <div class="progress-bar" role="progressbar" style="width: 0%" data-width="0"></div>
                                        </div>
                                        <p class="d-flex justify-content-between">
                                            <span>Funding Goal:</span>
                                            <span class="text-primary">{{ format_currency(project.funding_goal) }}</span>
                                        </p>
                                    </div>
                                    <div class="card-footer">
                                        <a href="{{ url_for('project_detail', project_id=project.id) }}" class="btn btn-primary w-100">View Details</a>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    
                    {% if projects|length > 3 %}
                        <div class="text-center mt-3">
                            <a href="{{ url_for('opportunities') }}" class="btn btn-outline">View All Projects</a>
                        </div>
                    {% endif %}
                {% else %}
                    <div class="text-center py-5">
                        <div class="feature-icon mb-3">
                            <i class="fas fa-search-dollar"></i>
                        </div>
                        <h4>No Matching Projects</h4>
                        <p class="text-secondary">Complete your investor profile to get matched with relevant agricultural projects</p>
                        <a href="{{ url_for('profile') }}" class="btn btn-primary mt-3">Complete Your Profile</a>
                    </div>
                {% endif %}
            </div>
            
            <!-- Investor's Active Investments -->
            <div class="dashboard-card mb-5">
                <div class="dashboard-card-title mb-4">
                    <h3>My Investments</h3>
                </div>
                
                {% if investments %}
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Project</th>
                                    <th>Amount</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for investment in investments %}
                                    {% set project = project_dict.get(investment.project_id) %}
                                    <tr>
                                        <td>{{ project.title if project else 'Unknown Project' }}</td>
                                        <td>{{ format_currency(investment.amount) }}</td>
                                        <td>{{ format_date(investment.created_at) }}</td>
                                        <td><span class="project-status status-pending">{{ investment.status }}</span></td>
                                        <td>
                                            <a href="{{ url_for('project_detail', project_id=investment.project_id) }}" class="btn btn-sm btn-outline">View Project</a>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <div class="feature-icon mb-3">
                            <i class="fas fa-hand-holding-usd"></i>
                        </div>
                        <h4>No Investments Yet</h4>
                        <p class="text-secondary">Start investing in promising agricultural projects</p>
                        <a href="{{ url_for('opportunities') }}" class="btn btn-primary mt-3">Browse Opportunities</a>
                    </div>
                {% endif %}
            </div>
        {% endif %}
    {% endif %}
    </div>
</section>
{% endblock %}
